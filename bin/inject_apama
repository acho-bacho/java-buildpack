#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

# parse args
BUILD_DIR=$1
CACHE_DIR=$2
TMP_INJECTOR_DIR=$BUILD_DIR/tmp_injector_dir

rm -rf $TMP_INJECTOR_DIR
mkdir $TMP_INJECTOR_DIR
cd $TMP_INJECTOR_DIR

# Gets Common JVM Buildpack BASH Functions
curl --silent --location http://heroku-jvm-common.s3.amazonaws.com/jvm-buildpack-common.tar.gz | tar xz
. bin/java

# create default system.properties 
if [ ! -f ${BUILD_DIR}/system.properties ]; then
  echo "java.runtime.version=1.8" > ${BUILD_DIR}/system.properties
fi

# install JDK 
javaVersion=$(detect_java_version ${BUILD_DIR})
echo -n "### Installing OpenJDK ${javaVersion}..."
install_java ${BUILD_DIR} ${javaVersion}
jdk_overlay ${BUILD_DIR}
echo "### installed java to ${BUILD_DIR}"

# Injector jars
INJ_DIR=injector
mkdir $INJ_DIR
wget ftp://ftp.softwareag.com/outgoing/Development/Platformers/CloudFoundry/akit/injector_libs.tar.gz
tar -xvf injector_libs.tar.gz -C $INJ_DIR

# Apama rules
BOSCH_DIR=Bosch
mkdir $BOSCH_DIR
wget ftp://ftp.softwareag.com/outgoing/Development/Platformers/CloudFoundry/akit/Bosch.tar.gz
tar -xvf Bosch.tar.gz -C $BOSCH_DIR

touch __BEFORE_IMPORT_APAMA_RULES
ftp://ftp.softwareag.com/outgoing/Development/Platformers/CloudFoundry/akit/importApamaRules --directory-prefix=$INJ_DIR
chmod +x $INJ_DIR/importApamaRules
$INJ_DIR/importApamaRules  > INJECT_OUTPUT.txt 2>&1
touch __AFTER_IMPORT_APAMA_RULES
cd ..

echo "### Finished"